<?xml version="1.0" encoding="UTF-8"?>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<!-- $Id: build-test.xml 60371 2007-02-07 11:48:07Z alesj $ -->

<project default="main" name="JBoss/AOPIntegration Tests">

  <!-- ================================================================== -->
  <!-- Setup                                                              -->
  <!-- ================================================================== -->

  <import file="../tools/etc/ant/common-tasks.xml" />

  <!-- ================================================================== -->
  <!-- Configuration                                                      -->
  <!-- ================================================================== -->

  <property name="source.java" value="src/tests" />
  <property name="source.resources" value="src/resources/tests" />
  <property name="javac.target" value="1.5" />
  <property name="javac.source" value="1.5" />
  <property name="build.classes" value="target/classes" />
  <property name="build.test.classes" value="target/test-classes" />
  <property name="build.testlog" value="output/log" />
  <property name="build-bypass.disabled" value="true" />

  <!--
     | Configure the build system.
     |
     | This target is invoked by the Buildmagic initialization logic and
     | should contain module specific configuration elements.
   -->

  <target name="init" depends="init-maven-environment">

    <!-- =================== -->
    <!-- Basic Configuration -->
    <!-- =================== -->

    <!-- this -->
    <property name="jboss.this.root" value="${module.root}/output" />
    <property name="jboss.this.lib" value="${jboss.this.root}/lib" />
    <property name="project.output" value="${maven.project.build.directory}"/>
    <property name="build.reports" value="${project.output}/reports"/>
    <property name="build.testlog" value="${build.reports}/tests.log"/>
    <property name="resources" value="${basedir}/src/resources"/>
    
    <path id="jboss.this.classpath">
      <fileset dir="${jboss.this.lib}">
        <include name="*.jar" />
        <exclude name="${jar.prefix}.jar" />
      </fileset>
    </path>

    <path id="test.classpath">
      <pathelement location="${maven.project.build.outputDirectory}"/>
      <pathelement location="${maven.project.build.testOutputDirectory}"/>
      <path refid="maven.dependencies.test.classpath" />
    </path>

    <!--<pathconvert property="test.classpath.stuff" refid="test.classpath"/>
    <echo message="${test.classpath.stuff}"/>-->
  </target>

  <!-- ================================================================== -->
  <!-- Compile                                                            -->
  <!-- ================================================================== -->

  <!--
     | Compile everything.
     |
     | This target should depend on other compile-* targets for each
     | different type of compile that needs to be performed, short of
     | documentation compiles.
   -->

  <target name="compile" description="Compile all source files." />

  <!-- ================================================================== -->
  <!-- Archives                                                           -->
  <!-- ================================================================== -->

  <!-- >

    <jar destfile="${build.lib}/jbossas-integration-test.jar" manifest="${build.etc}/default.mf">
      <fileset dir="${build.classes}" />
      <fileset dir="${build.resources}">
        <include name="org/**" />
      </fileset>
    </jar>

  </target>-->

  <!-- ================================================================== -->
  <!-- Tests                                                              -->
  <!-- ================================================================== -->

  <target name="tests" depends="init"  description="Execute all tests in the given test directory.">
    <mkdir dir="${build.reports}" />
    <!-- Remove the test.log so each run has a fresh log -->
    <delete file="${build.testlog}" />
    <junit dir="${project.output}" printsummary="yes" haltonerror="false" haltonfailure="false" fork="true">

      <sysproperty key="build.testlog" value="${build.testlog}" />
      <sysproperty key="log4j.configuration" value="file:${resources}/tests/log4j.xml" />

      <classpath>
        <path refid="test.classpath" />
      </classpath>

      <formatter type="plain" usefile="true" />
      <formatter type="xml" usefile="true" />

      <batchtest todir="${build.reports}" haltonerror="false" haltonfailure="false" fork="true">
        <fileset dir="${build.test.classes}">
          <include name="org/jboss/test/**/*UnitTestCase.class" />
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="one-test" depends="init"  description="Execute all tests in the given test directory.">
    <mkdir dir="${build.reports}" />

    <!-- Remove the test.log so each run has a fresh log -->
    <delete file="${build.testlog}" />
    <junit dir="${project.output}" printsummary="yes" haltonerror="false" haltonfailure="false" fork="true">

      <sysproperty key="build.testlog" value="${build.testlog}" />
      <sysproperty key="log4j.configuration" value="file:${resources}/tests/log4j.xml" />

      <classpath>
        <pathelement path="${test.classpath}" />
      </classpath>

      <formatter type="plain" usefile="true" />
      <formatter type="xml" usefile="true" />

      <test todir="${build.reports}" name="${test}" haltonerror="${junit.batchtest.haltonerror}" haltonfailure="${junit.batchtest.haltonfailure}" fork="${junit.batchtest.fork}" />
    </junit>
  </target>

  <target name="memory-test" depends="init"  description="Execute MemoryLeakTestCase">
    <mkdir dir="${build.reports}" />

    <sysproperty key="build.testlog" value="${build.testlog}" />
    <sysproperty key="log4j.configuration" value="file:${resources}/tests/log4j.xml" />
    
    <junit printsummary="yes" fork="yes" haltonfailure="no">
      <classpath>
        <pathelement path="${test.classpath}" />
      </classpath>
      <jvmarg value="-agentlib:jbossAgent" />
      <formatter type="plain" usefile="true" />
      <formatter type="xml" usefile="true" />
      <test fork="yes" todir="${build.reports}" name="org.jboss.test.memorytests.ClassInfoMemoryTestCase" />
    </junit>

  </target>
  
  <target name="main">
  </target>
  

</project>
