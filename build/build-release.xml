<?xml version="1.0" encoding="UTF-8"?>

<project name="JBoss AOP/Build Release" default="release-no-reference-docs">
   <target name="release-no-reference-docs"
	       description="Builds the default release structure, minus the reference documentation"
         depends="init-dependency-properties">
      <delete dir="output/temp"/>
      <mkdir dir="output/temp"/>

      <!-- ==================================================  -->
      <!--           Add the files from 'aop'                  -->
      <!-- ==================================================  -->

      <!-- build.xml that will compile src/tests and run tests from the dist package -->
      <copy todir="${project.release}" filtering="no">
         <fileset dir="${project.root}/build/build_for_dist">
            <include name="build.xml"/>
         </fileset>
      </copy>

      <copy todir="${project.release}/etc" filtering="no">
         <fileset dir="${project.root}/aop/src/etc">
            <include name="default.mf"/>
            <include name="jbossorg-eula.txt"/>
            <include name="pluggable-instrumentor.mf"/>
         </fileset>
      </copy>

      <!-- needed to build the source/tests from the dist package -->
      <copy file="${jboss:jboss-test:jar}"
            tofile="${project.release}/lib-test/jboss-test.jar"/> 
      <copy file="${junit:junit:jar}"
            tofile="${project.release}/lib-test/junit.jar"/>
      <copy file="${jboss.profiler.jvmti:jboss-profiler-jvmti:jar}"
            tofile="${project.release}/lib-test/jboss-profiler-jvmti.jar"/>
      
      <copy todir="${project.release}/bin" filtering="no">
         <fileset dir="${project.root}/aop/src/resources/bin">
            <include name="**/*"/>
         </fileset>
      </copy>

      <copy todir="${project.release}/docs/aspect-framework" filtering="no">
         <fileset dir="${project.root}/aop/docs">
            <include name="api/**"/>
            <include name="**/*.html"/>
            <include name="**/*.pdf"/>
            <include name="**/*.jpg"/>
            <include name="**/*.pdf"/>
            <include name="**/*.css"/>
            <include name="examples/**"/>
            <exclude name="**/CVS/**"/>
            <exclude name="**/.svn/**"/>
            <exclude name="**/*.wiki"/>
            <exclude name="reference/**"/>
         </fileset>
      </copy>

      <copy todir="${project.release}/docs/aspect-framework" filtering="no">
         <fileset dir="${project.root}/aop/target/site">
            <include name="apidocs/**"/>
         </fileset>
      </copy>


      <copy todir="${project.release}/src/aspect-framework" filtering="no">
         <fileset dir="${project.root}/aop/src">
            <include name="main/**/*.java"/>
            <include name="main/**/*.jjt"/>
            <include name="test/**/*.java"/>
            <include name="resources/test/**/*.xml"/>
            <include name="resources/bin/**/*"/>
            <exclude name="**/.svn/**"/>
            <exclude name="**/CVS/**"/>
         </fileset>
      </copy>

      <!-- ==================================================  -->
      <!-- Add the files from 'asintegration'                  -->
      <!-- ==================================================  -->

      <copy todir="${project.release}/docs/asintegration-core" filtering="no">
         <fileset dir="${project.root}/asintegration-core/target/site">
            <include name="apidocs/**"/>
         </fileset>
      </copy>
      <copy todir="${project.release}/docs/asintegration-jmx" filtering="no">
         <fileset dir="${project.root}/asintegration-jmx/target/site">
            <include name="apidocs/**"/>
         </fileset>
      </copy>
      <copy todir="${project.release}/docs/asintegration-mc" filtering="no">
         <fileset dir="${project.root}/asintegration-mc/target/site">
            <include name="apidocs/**"/>
         </fileset>
      </copy>

      <copy todir="${project.release}/src/asintegration-core" filtering="no">
         <fileset dir="${project.root}/asintegration-core/src">
            <include name="main/**/*.java"/>
            <include name="etc/**"/>
            <include name="resources/**"/>
            <exclude name="**/.svn/**"/>
            <exclude name="**/CVS/**"/>
         </fileset>
      </copy>
      <copy todir="${project.release}/src/asintegration-jmx" filtering="no">
         <fileset dir="${project.root}/asintegration-jmx/src">
            <include name="main/**/*.java"/>
            <include name="etc/**"/>
            <include name="resources/**"/>
            <exclude name="**/.svn/**"/>
            <exclude name="**/CVS/**"/>
         </fileset>
      </copy>
      <copy todir="${project.release}/src/asintegration-mc" filtering="no">
         <fileset dir="${project.root}/asintegration-mc/src">
            <include name="main/**/*.java"/>
            <include name="etc/**"/>
            <include name="resources/**"/>
            <exclude name="**/.svn/**"/>
            <exclude name="**/CVS/**"/>
         </fileset>
      </copy>

      <!-- ==================================================  -->
      <!-- Add the files from 'aspects'                        -->
      <!-- ==================================================  -->

      <copy todir="${project.release}/docs/aspects" filtering="no">
         <fileset dir="${project.root}/aspects/target/site">
            <include name="apidocs/**"/>
         </fileset>
      </copy>

      <copy todir="${project.release}/src/aspects" filtering="no">
         <fileset dir="${project.root}/aspects/src">
            <include name="main/**/*.java"/>
            <include name="test/**/*.java"/>
            <include name="resources/**"/>
            <exclude name="**/.svn/**"/>
            <exclude name="**/CVS/**"/>
         </fileset>
      </copy>


      <!-- ==================================================  -->
      <!-- Now pull everything together                        -->
      <!-- ==================================================  -->

      <property name="aop.50.location" value="${project.root}/aop/output/lib/jboss-aop-jdk50.jar"/>
      <property name="aop.50.single.location" value="${project.root}/aop/output/lib/jboss-aop-jdk50-single.jar"/>
      <property name="aop.aspect-library50.location" value="${project.root}/aspects/output/lib/jboss-standalone-aspect-library-jdk50.jar"/>
      <property name="aop.asintegration-core.location" value="${project.root}/asintegration-core/target/jboss-aop-asintegration-core.jar"/>
      <property name="aop.asintegration-jmx.location" value="${project.root}/asintegration-jmx/target/jboss-aop-asintegration-jmx.jar"/>
      <property name="aop.asintegration-mc.location" value="${project.root}/asintegration-mc/target/jboss-aop-asintegration-mc.jar"/>      
      <property name="aop.jrockit-pluggable-instrumentor.location" value="${project.root}/jrockit-pluggable-instrumentor/target/jrockit-pluggable-instrumentor.jar"/>
      <property name="aop.pluggable-instrumentor.location" value="${project.root}/pluggable-instrumentor/target/pluggable-instrumentor.jar"/>
      <property name="aop.readme-as4.location" value="${project.root}/asintegration-core/src/etc/ReadMe-AS4.txt"/>
      <property name="aop.readme-as5.location" value="${project.root}/asintegration-core/src/etc/ReadMe-AS5.txt"/>
      <property name="aop.jboss-service.location" value="${project.root}/asintegration-jmx/src/resources/META-INF/jboss-service.xml"/>

      <!-- Copy across the eula -->
      <copy todir="${project.release}" file="${project.root}/aop/src/etc/jbossorg-eula.txt"/>

      <!-- The JDK 5 libs -->
      <copy todir="${project.release}/lib-50" file="${aop.50.location}"/>
      <copy todir="${project.release}/lib-50" file="${aop.50.single.location}"/>
      <copy todir="${project.release}/lib-50" file="${project.root}/aop/output/lib/jboss-aop-jdk50-client.jar"/>
      <copy todir="${project.release}/lib-50" file="${aop.aspect-library50.location}"/>
      <copy todir="${project.release}/lib-50" file="${aop.jrockit-pluggable-instrumentor.location}"/>
      <copy todir="${project.release}/lib-50" file="${aop.pluggable-instrumentor.location}"/>
      <copy tofile="${project.release}/lib-50/javassist.jar" file="${javassist:javassist:jar}"/>
      <copy tofile="${project.release}/lib-50/jboss-common-core.jar" file="${org.jboss:jboss-common-core:jar}"/>

      <copy tofile="${project.release}/lib-50/jboss-reflect.jar" file="${org.jboss:jboss-reflect:jar}"/>
      <copy tofile="${project.release}/lib-50/jboss-mdr.jar" file="${org.jboss:jboss-mdr:jar}"/>

      <copy tofile="${project.release}/lib-50/jboss-logging-log4j.jar" file="${org.jboss.logging:jboss-logging-log4j:jar}"/>
      <copy tofile="${project.release}/lib-50/jboss-logging-spi.jar" file="${org.jboss.logging:jboss-logging-spi:jar}"/>
      <copy tofile="${project.release}/lib-50/log4j.jar" file="${log4j:log4j:jar}"/>
      <copy tofile="${project.release}/lib-50/trove.jar" file="${trove:trove:jar}"/>

      <!-- The JBoss 4.0.x and 4.2.x libs for JDK 5 -->
      <copy file="${aop.jboss-service.location}" tofile="output/temp/jboss-service-jdk50.xml" filtering="true">
         <filterset>
            <filter token="SERVICE_NAME" value="org.jboss.aop.deployment.AspectManagerServiceJDK5"/>
         </filterset>
      </copy>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/build_jboss4.0.xml" file="../asintegration-core/src/etc/jboss-40-install-jboss-aop-jdk50-build.xml"/>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/build.xml" file="../asintegration-core/src/etc/jboss-42-install-jboss-aop-jdk50-build.xml"/>
      <copy todir="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer" file="../asintegration-core/src/etc/jboss.properties"/>
      <copy todir="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer" file="${aop.50.location}"/>
      <copy todir="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer" file="${aop.aspect-library50.location}"/>
      <copy todir="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer" file="${aop.asintegration-core.location}"/>
      <copy todir="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer" file="${aop.asintegration-jmx.location}"/>
      <copy todir="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer" file="${aop.readme-as4.location}"/>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/jboss-reflect.jar" file="${org.jboss:jboss-reflect:jar}"/>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/jboss-mdr.jar" file="${org.jboss:jboss-mdr:jar}"/>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/jboss-common-core.jar" file="${org.jboss:jboss-common-core:jar}"/>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/javassist.jar" file="${javassist:javassist:jar}"/>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/trove.jar" file="${trove:trove:jar}"/>
      <copy tofile="${project.release}/jboss-40-install/jboss-aop-jdk50.deployer/META-INF/jboss-service.xml" file="output/temp/jboss-service-jdk50.xml"/>

      <!-- The JBoss 5 libs for JDK 5 (JBoss 5 needs JDK 5) -->
      <copy todir="${project.release}/jboss-50-install/lib" file="${aop.50.location}"/>
      <copy todir="${project.release}/jboss-50-install/lib" file="${aop.asintegration-core.location}"/>
      <copy todir="${project.release}/jboss-50-install/lib" file="${aop.asintegration-mc.location}"/>
      <copy todir="${project.release}/jboss-50-install/lib" file="${aop.asintegration-jmx.location}"/>
      <copy todir="${project.release}/jboss-50-install" file="${aop.readme-as5.location}"/>
      <copy tofile="${project.release}/jboss-50-install/lib/javassist.jar" file="${javassist:javassist:jar}"/>
      <copy tofile="${project.release}/jboss-50-install/lib/trove.jar" file="${trove:trove:jar}"/>
      <copy todir="${project.release}/jboss-50-install/jboss-aop-jboss5.deployer" file="${aop.aspect-library50.location}"/>


      <copy todir="${project.release}" file="RELEASE_NOTES.html"/>

<!--      <delete dir="output/temp"/>  -->

  </target>

  <target name="release-reference-docs"
     description="Builds the default release structure, minus the reference documentation">

      <copy todir="${project.release}/docs/aspect-framework" filtering="no">
         <fileset dir="${project.root}/aop/docs/reference/build">
            <include name="**"/>
         </fileset>
      </copy>

  </target>

  <target name="init-dependency-properties"
     description="Initialize properties for accessing maven dependencies"
     xmlns:maven="urn:maven-artifact-ant">
     
    <path id="maven-ant-tasks.classpath" path="../tools/lib/maven-ant-tasks.jar" />
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml" uri="urn:maven-artifact-ant"
             classpathref="maven-ant-tasks.classpath"/>
     
    <maven:pom id="aop.framework.pom" file="../aop/pom.xml" />
     
     <!-- This tasks resolves maven dependencies and creates a property of the
       -  form groupId:artifactId:type that points to the dependency jar file.
       -->
    <maven:dependencies pathId="dist.dependencies.classpath" 
          versionsId="maven.dependency.versions">
       <pom refid="aop.framework.pom"/>
    </maven:dependencies>
     
  </target>
   
</project>
