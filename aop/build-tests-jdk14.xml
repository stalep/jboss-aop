<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project [
   <!ENTITY buildmagic SYSTEM "../tools/etc/buildmagic/buildmagic.ent">
   <!ENTITY libraries SYSTEM "../thirdparty/libraries.ent">
   <!ENTITY modules SYSTEM "../tools/etc/buildmagic/modules.ent">
]>

<!-- ====================================================================== -->
<!--                                                                        -->
<!--  JBoss, the OpenSource J2EE webOS                                      -->
<!--                                                                        -->
<!--  Distributable under LGPL license.                                     -->
<!--  See terms of license at http://www.gnu.org.                           -->
<!--                                                                        -->
<!-- ====================================================================== -->

<!-- $Id$ -->

<project default="main" name="JBoss/AOP">

   <!-- ================================================================== -->
   <!-- Setup                                                              -->
   <!-- ================================================================== -->

   <!--
      | Include the common Buildmagic elements.
      |
      | This defines several different targets, properties and paths.
      | It also sets up the basic extention tasks amoung other things.
    -->

   &buildmagic;

   <import file="base-tests.xml"/>


   <!-- ================================================================== -->
   <!-- Initialization                                                     -->
   <!-- ================================================================== -->

   <!--
      | Initialize the build system.  Must depend on '_buildmagic:init'.
      | Other targets should depend on 'init' or things will mysteriously fail.
    -->

   <target name="init" unless="init.disable" depends="_buildmagic:init">
   </target>


   <!-- ================================================================== -->
   <!-- Configuration                                                      -->
   <!-- ================================================================== -->

   <!--
      | Configure the build system.
      |
      | This target is invoked by the Buildmagic initialization logic and
      | should contain module specific configuration elements.
    -->

   <target name="configure" unless="configure.disable">
      <property name="aop.version" value="jboss-aop-1.5.0.GA"/>
      <property name="aop.title" value="JBoss AOP Framework"/>

      <!-- =================== -->
      <!-- Basic Configuration -->
      <!-- =================== -->

      <!-- Module name(s) & version -->
      <property name="module.name" value="aop"/>
      <property name="module.Name" value="JBoss AOP"/>
      <property name="module.version" value="1.5.0.GA"/>

      <!-- ========= -->
      <!-- Libraries -->
      <!-- ========= -->

      &libraries;
      &modules;
      <!-- The combined library classpath - we don't want everything included here since some of these tests use the -Xbootclasspath/p: option-->
      <path id="library.classpath">
         <path refid="apache.log4j.classpath"/>
         <path refid="javassist.classpath"/>
         <path refid="jboss.profiler.jvmti.classpath"/>
         <path refid="jboss/common.logging.log4j.classpath"/>
         <path refid="jboss/common.logging.jdk.classpath"/>
         <path refid="jboss/common.logging.spi.classpath"/>
         <path refid="qdox.classpath"/>
         <path refid="trove.classpath"/>
         <path refid="xdoclet.xdoclet.classpath"/>
       </path>

      <!--
            Settable in local.properties:
               -jrockit.home: location of JRockit JVM
               -jdk14.executable: Full path to a JDK 1.4 java.exe (Needed for the JDK 1.4 tests)
               -repository.home: Location of local copy of repository (for the "update-repository" target
               -debug: if set, -Djboss.aop.debug.classes=true for the tests; otherwise it is false
       -->
      <property file="local.properties"/>

      <condition property="jboss.aop.debug.classes" value="true">
         <isset property="debug"/>
      </condition>
      <condition property="jboss.aop.debug.classes" value="false">
         <not>
            <isset property="debug"/>
         </not>
      </condition>



      <fail unless="jdk14.executable">Need to set jdk14.executable to a jdk 1.4 executable in local.properties. For example
      jdk14.executable=C:/Java/jdk14/bin/java.exe
      </fail>
      <property name="java14" value="${jdk14.executable}"/>

      <!-- ======= -->
      <!-- Modules -->
      <!-- ======= -->

      <!-- The combined dependent module classpath -->
      <path id="dependentmodule.classpath">
      </path>

      <!-- ===== -->
      <!-- Tasks -->
      <!-- ===== -->

      <!-- Where source files live -->
      <property name="source.tests.java" value="${module.source}/test"/>
      <property name="source.res" value="${module.source}/resources"/>

      <!-- Where build generated files will go -->
      <property name="build.reports" value="${module.output}/reports"/>
      <property name="build.tests.classes" value="${module.output}/tests.classes"/>
      <property name="build.tests.retro" value="${module.output}/tests.retro"/>
      <property name="build.lib" value="${module.output}/lib"/>
      <property name="build.api" value="${module.output}/api"/>
      <property name="build.etc" value="${module.output}/etc"/>
      <property name="build.gen-src" value="${module.output}/gen-src"/>
      <property name="build.gen" value="${module.output}/gen"/>
      <property name="build.bootclasspath" value="${module.output}/gen-bootclasspath"/>

      <!-- Install/Release structure -->
      <property name="install.id" value="${module.name}-${module.version}"/>
      <property name="release.id" value="${install.id}"/>
      <property name="install.root" value="${module.output}/${install.id}"/>

      <!-- The combined thirdparty classpath -->
      <path id="thirdparty.classpath">
         <path refid="library.classpath"/>
         <path refid="dependentmodule.classpath"/>
      </path>

      <!-- classpath and local.classpath must have a value using with a path -->
      <property name="classpath" value=""/>
      <property name="local.classpath" value=""/>

      <!-- The classpath required to build classes. -->
      <path id="javac.classpath">
         <pathelement path="${classpath}"/>
         <pathelement path="${local.classpath}"/>
         <path refid="thirdparty.classpath"/>
         <path refid="jboss.test14.classpath"/>
         <path refid="jboss.microcontainer.classpath"/>
         <path refid="jboss/common.core.classpath"/>
         <pathelement path="${build.lib}/jboss-aop-jdk50.jar"/>
         <path refid="junit.junit.classpath"/>
      </path>

      <path id="jbossretro.classpath">
         <path refid="apache.ant.classpath"/>
         <path refid="javassist.classpath"/>
         <path refid="org/jboss/jboss.retro.classpath"/>
         <path refid="jboss/backport.concurrent.classpath"/>
      </path>

      <path id="jbossretrort.classpath">
         <path refid="jboss/backport.concurrent.classpath"/>
         <pathelement path="${org/jboss/jboss.retro.lib}/jboss-retro-rt.jar"/>
         <path refid="jboss.microcontainer14.classpath"/>
         <path refid="jboss/common.core.14.classpath"/>
      </path>

      <path id="jboss.aop.retro.classpath">
         <path refid="jboss.aop14.classpath"/>
         <path refid="jbossretrort.classpath"/>
      </path>

     <path id="aopc.classpath">
         <path refid="thirdparty.classpath"/>
          <path refid="junit.junit.classpath"/>
         <path refid="jbossretrort.classpath"/>
         <path refid="jboss.test14.classpath"/>
     </path>

      <!-- run against jdk 14 jar -->
      <path id="test.classpath">
         <path refid="thirdparty.classpath"/>
         <path refid="jbossretrort.classpath"/>
         <path refid="jboss.aop14.classpath"/>
      </path>

      <!-- The temp folder for aopc -->
      <property name="aopc.tmpdir" value="output/aopctmp"/>
      <delete dir="${aopc.tmpdir}" failonerror="true" deleteonexit="true"/>
   	<mkdir dir="${aopc.tmpdir}"/>

      <!-- Packages to include when generating api documentation -->
      <property name="javadoc.packages" value="org.jbos.aop.*"/>

      <!-- Override JUnit defaults -->
      <property name="junit.timeout" value="240000"/> <!-- 4 minutes -->
      <property name="junit.batchtest.todir" value="${build.reports}"/>
      <property name="junit.jvm.options" value="-Ddummy"/>
   </target>


   <!-- ================================================================== -->
   <!-- Compile                                                            -->
   <!-- ================================================================== -->

   <target name="compile"
      description="Compile all source files."
      depends="compile-test-classes"/>

   <target name="compile-test-classes" depends="init">
      <mkdir dir="${build.tests.classes}"/>
      <javac destdir="${build.tests.classes}"
         optimize="${javac.optimize}"
         target="1.5"
         source="1.5"
         debug="${javac.debug}"
         depend="${javac.depend}"
         verbose="${javac.verbose}"
         deprecation="${javac.deprecation}"
         includeAntRuntime="${javac.include.ant.runtime}"
         includeJavaRuntime="${javac.include.java.runtime}"
         failonerror="${javac.fail.onerror}">
         <src path="${source.tests.java}"/>
         <classpath refid="javac.classpath"/>
         <include name="**/*.java"/>
         <exclude name="org/jboss/test/aop/memoryleaks/**/*.java"/>
      </javac>
   </target>

   <target name="retroweave" depends="compile-test-classes">
      <mkdir dir="${build.tests.retro}"/>

      <taskdef name="retro" classname="org.jboss.ant.tasks.retro.Retro" classpathref="jbossretro.classpath"/>
      <retro compilerclasspathref="jbossretro.classpath" destdir="${build.tests.retro}">
         <classpath refid="jbossretro.classpath"/>
         <classpath refid="javac.classpath"/>
         <classpath>
            <pathelement path="${build.tests.classes}"/>
         </classpath>
         <src path="${build.tests.classes}"/>
      </retro>
   </target>


   <!-- ================================================================== -->
   <!-- Cleaning                                                           -->
   <!-- ================================================================== -->

   <!-- Clean up all build output -->
   <target name="clean" description="Cleans up most generated files." depends="init">
      <delete dir="${build.tests.classes}"/>
      <delete dir="${build.tests.retro}"/>
   </target>

   <target name="clean-tests" depends="init">
      <delete dir="${build.tests.classes}"/>
   </target>

   <!-- Clean up all generated files -->
   <target name="clobber"
      description="Cleans up all generated files."
      depends="_buildmagic:clobber, clean">
   </target>


   <!-- ===============================================================p=== -->
   <!-- Misc.                                                              -->
   <!-- ================================================================== -->

   <target name="main" depends="most"
      description="Executes the default target (most)."/>

   <target name="all" depends="compile"
      description="Builds everything."/>

   <target name="most" depends="compile"
      description="Builds almost everything."/>

   <target name="help"
      description="Show this help message."
      depends="_buildmagic:help:standard"/>

   <!-- ==================================================================================== -->
   <!-- JDK 1.4 TESTS                                                                        -->
   <!-- ==================================================================================== -->
   <target name="tests" depends="main">

      <antcall target="clean"/>
      <antcall target="bootclasspath-genadvisor-tests" inheritRefs="true"/>
      <antcall target="bootclasspath-tests" inheritRefs="true"/>
      <antcall target="system-classloader-test" inheritRefs="true"/>
      <antcall target="not-woven-tests" inheritRefs="true"/>

      <antcall target="clean"/>
      <antcall target="precompiled-tests" inheritRefs="true"/>

      <antcall target="clean"/>
      <antcall target="precompiled-genadvisor-tests" inheritRefs="true"/>

      <antcall target="clean"/>
      <antcall target="non-optimized-precompiled-tests" inheritRefs="true"/>
   </target>

   <!-- ==================================================================================== -->
   <!-- BOOTCLASSPATH-TESTS (JDK 1.4)                                                        -->
   <!-- ==================================================================================== -->
   <target name="bootclasspath-tests" depends="retroweave">
      <delete dir="${build.bootclasspath}"/>
      <java fork="yes" classname="org.jboss.aop.hook.GenerateInstrumentedClassLoader" jvm="${java14}">
         <classpath>
            <path refid="test.classpath"/>
         </classpath>
         <arg value="${build.bootclasspath}"/>
      </java>

      <!-- Add tests in _base-tests unless they should only be run in this weaving mode -->
      <antcall target="_base-tests" inheritRefs="true">
         <param name="caller" value="bootclasspath-tests"/>
         <param name="test-target" value="_run-bootclasspath-test"/>
      </antcall>

      <!-- Tests only applicable for this weaving mode -->
      <antcall target="_run-bootclasspath-test" inheritRefs="true">
         <param name="test" value="override"/>
         <param name="caller" value="bootclasspath-tests"/>
         <param name="exclude" value="**/GenAdvisorOverrideTestCase.class"/>
      </antcall>
   </target>

   <!-- ==================================================================================== -->
   <!-- GENERATED ADVISOR BOOTCLASSPATH-TESTS (JDK 1.4)                                      -->
   <!-- ==================================================================================== -->
   <target name="bootclasspath-genadvisor-tests" depends="retroweave">
      <delete dir="${build.bootclasspath}"/>
      <java fork="yes" classname="org.jboss.aop.hook.GenerateInstrumentedClassLoader" jvm="${java14}">
         <classpath>
            <path refid="test.classpath"/>
         </classpath>
         <arg value="${build.bootclasspath}"/>
      </java>

      <!-- Tests only applicable for this weaving mode -->
      <antcall target="_run-bootclasspath-test" inheritRefs="true">
         <param name="test" value="override"/>
         <param name="caller" value="bootclasspath-genadvisor-tests"/>
         <param name="exclude" value="**/OverrideTestCase.class"/>
      </antcall>
      <antcall target="_run-bootclasspath-test" inheritRefs="true">
         <param name="test" value="nameddomain"/>
         <param name="caller" value="bootclasspath-genadvisor-tests"/>
      </antcall>

      <!-- Add tests in _base-tests unless they should only be run in this weaving mode -->
      <antcall target="_base-tests" inheritRefs="true">
         <param name="caller" value="bootclasspath-genadvisor-tests"/>
         <param name="test-target" value="_run-bootclasspath-test"/>
      </antcall>

   </target>

   <target name="loadtime-test" depends="init">
      <antcall  target="_run-bootclasspath-test" inheritRefs="true">
         <param name="test" value="${test}"/>
         <param name="caller" value="bootclasspath-tests"/>
      </antcall>
   </target>

   <!-- ==================================================================================== -->
   <!-- JDK 1.4 BOOTCLASSPATH TEST COMMONS                                                   -->
   <!-- These targets should not be called directly, use bootclasspath-tests or              -->
   <!-- bootclasspath-genadvisor-tests                                                       -->
   <!-- ==================================================================================== -->

   <target name="_run-bootclasspath-test">
      <path id="bootclasspath">
         <pathelement location="${build.bootclasspath}"/>
         <path refid="test.classpath"/>
      </path>
      <property name="bootclasspath" refid="bootclasspath"/>

      <!-- Check for jboss-aop.xml override -->
      <condition property="jboss.aop.path" value="${aop.xml}">
         <isset property="aop.xml"/>
      </condition>
      <condition property="jboss.aop.path" value="">
         <isset property="no.xml"/>
      </condition>
      <condition property="jboss.aop.path" value="${source.res}/test/${test}/jboss-aop.xml">
         <not>
            <isset property="aop.xml"/>
         </not>
      </condition>

      <!-- Get -Djboss.aop.class.path from passed in parameters -->
      <condition property="jboss.aop.class.path" value="${build.tests.classes}">
         <isset property="use.annotations"/>
      </condition>
      <condition property="jboss.aop.class.path" value="">
         <not>
            <isset property="use.annotations"/>
         </not>
      </condition>

      <!-- Set the weaving mode and instrumentor to use-->
      <condition property="instrumentor" value="org.jboss.aop.instrument.ClassicInstrumentor">
         <equals arg1="${caller}" arg2="bootclasspath-tests"/>
      </condition>
      <condition property="instrumentor" value="org.jboss.aop.instrument.GeneratedAdvisorInstrumentor">
         <equals arg1="${caller}" arg2="bootclasspath-genadvisor-tests"/>
      </condition>

      <echo>Running ${test} with instrumentor ${instrumentor}</echo>

      <mkdir dir="${build.reports}"/>
      <junit printsummary="yes" fork="yes" haltonfailure="no" jvm="${java14}">
         <jvmarg value="-Xbootclasspath/p:${bootclasspath}"/>
         <sysproperty key="jboss-junit-configuration" value="${caller}-jdk14"/>
         <sysproperty key="jboss.aop.path" value="${jboss.aop.path}"/>
         <sysproperty key="jboss.aop.class.path" value="${jboss.aop.class.path}"/>
         <sysproperty key="jboss.aop.instrumentor" value="${instrumentor}"/>
         <sysproperty key="jboss.aop.debug.classes" value="${jboss.aop.debug.classes}"/>
         <formatter type="plain" extension="-${caller}-jdk14.txt"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="true" extension="-${caller}-jdk14.xml"/>
         <classpath>
            <pathelement location="${build.tests.retro}"/>
            <path refid="jboss.test14.classpath"/>
         </classpath>
         <batchtest todir="${build.reports}"
            haltonerror="false"
            haltonfailure="false"
            fork="true">
            <fileset dir="${build.tests.retro}">
               <include name="org/jboss/test/aop/${test}/**/*TestCase.class"/>
               <include name="org/jboss/test/aop/${test}/**/*Tester.class"/>
               <exclude name="${exclude}"/>

               <!-- These are not test cases, and so they will fail when junit tries to run them. Should really rename all tests to *TestCase -->
               <exclude name="org/jboss/test/aop/reflection/ReflectionAspectTester.class"/>
               <exclude name="org/jboss/test/aop/basic/POJOAspectTester.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>

   <!-- ==================================================================================== -->
   <!-- OPTIMIZED PRECOMPILED TESTS (JDK 1.4)                                                -->
   <!-- ==================================================================================== -->

   <target name="precompiled-tests" depends="retroweave">

      <!-- Add tests in _base-precompiled-tests unless they should only be run in this weaving mode -->
      <antcall target="_base-tests" inheritRefs="true">
         <param name="caller" value="precompiled-tests"/>
         <param name="test-target" value="_run-precompiled-test"/>
      </antcall>

      <!-- Tests only applicable for this weaving mode -->

      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="args"/>
         <param name="caller" value="precompiled-tests"/>
      </antcall>

      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="override"/>
         <param name="caller" value="precompiled-tests"/>
         <param name="exclude" value="**/GenAdvisorOverrideTestCase.class"/>
      </antcall>
   </target>

   <!-- ==================================================================================== -->
   <!-- NON OPTIMIZED PRECOMPILED TESTS (JDK 1.4)                                            -->
   <!-- ==================================================================================== -->

   <target name="non-optimized-precompiled-tests" depends="retroweave">

      <!-- Tests only applicable for this weaving mode -->
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="override"/>
         <param name="caller" value="non-optimized-precompiled-tests"/>
         <param name="exclude" value="**/GenAdvisorOverrideTestCase.class"/>
      </antcall>

      <!-- Add tests in _base-precompiled-tests unless they should only be run in this weaving mode -->
      <antcall target="_base-tests" inheritRefs="true">
         <param name="caller" value="non-optimized-precompiled-tests"/>
         <param name="test-target" value="_run-precompiled-test"/>
      </antcall>

   </target>

   <target name="non-optimized-precompiled-test" depends="retroweave">
      <antcall  target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="${test}"/>
         <param name="caller" value="non-optimized-precompiled-tests"/>
      </antcall>
   </target>

   <!-- ==================================================================================== -->
   <!-- JDK 1.4 GENERATED ADVISOR PRECOMPILED TESTS                                          -->
   <!-- ==================================================================================== -->

   <target name="precompiled-genadvisor-tests" depends="retroweave">

      <!-- Add tests in _base-precompiled-tests unless they should only be run in this weaving mode -->
      <antcall target="_base-tests" inheritRefs="true">
         <param name="caller" value="precompiled-genadvisor-tests"/>
         <param name="test-target" value="_run-precompiled-test"/>
      </antcall>

      <!-- Tests only applicable for this weaving mode -->
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="args"/>
         <param name="caller" value="precompiled-genadvisor-tests"/>
      </antcall>
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="beforeafter"/>
         <param name="caller" value="precompiled-genadvisor-tests"/>
      </antcall>
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="beforeafterArgs"/>
         <param name="caller" value="precompiled-genadvisor-tests"/>
      </antcall>
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="dynamicgenadvisor"/>
         <param name="caller" value="precompiled-genadvisor-tests"/>
      </antcall>
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="override"/>
         <param name="caller" value="precompiled-genadvisor-tests"/>
         <param name="exclude" value="**/OverrideTestCase.class"/>
      </antcall>
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="nameddomain"/>
         <param name="caller" value="precompiled-genadvisor-tests"/>
      </antcall>
   </target>

   <target name="precompiled-test" depends="retroweave">
      <antcall  target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="${test}"/>
         <param name="caller" value="precompiled-tests"/>
      </antcall>
   </target>

   <target name="precompiled-genadvisor-test" depends="retroweave">
      <antcall target="_run-precompiled-test" inheritRefs="true">
         <param name="test" value="args"/>
         <param name="caller" value="precompiled-genadvisor-tests"/>
      </antcall>
   </target>

   <target name="_run-precompiled-test">

      <taskdef name="aopc" classname="org.jboss.aop.ant.AopC" classpathref="jboss.aop.retro.classpath"/>
      <path id="aop.task.classpath">
         <path refid="library.classpath"/>
         <path refid="dependentmodule.classpath"/>
         <path refid="aopc.classpath"/>
      </path>


      <!-- Check for jboss-aop.xml override for compiler -->
      <condition property="aoppath" value="${aop.xml}">
         <isset property="aop.xml"/>
      </condition>
      <condition property="aoppath" value="">
         <isset property="no.xml"/>
      </condition>
      <condition property="aoppath" value="${source.res}/test/${test}/jboss-aop.xml">
         <not>
            <isset property="aop.xml"/>
         </not>
      </condition>

      <!-- Set the weaving mode and instrumentor to use-->
      <condition property="optimized" value="true">
         <or>
            <equals arg1="${caller}" arg2="precompiled-tests"/>
            <equals arg1="${caller}" arg2="precompiled-genadvisor-tests"/>
         </or>
      </condition>
      <condition property="optimized" value="false">
         <equals arg1="${caller}" arg2="non-optimized-precompiled-tests"/>
      </condition>
      <condition property="instrumentor" value="org.jboss.aop.instrument.ClassicInstrumentor">
         <not>
            <equals arg1="${caller}" arg2="precompiled-genadvisor-tests"/>
         </not>
      </condition>
      <condition property="instrumentor" value="org.jboss.aop.instrument.GeneratedAdvisorInstrumentor">
         <equals arg1="${caller}" arg2="precompiled-genadvisor-tests"/>
      </condition>

      <echo>Compiling ${test} with optimized=${optimized} and instrumentor ${instrumentor}</echo>

      <!-- aopc -->
      <aopc optimized="${optimized}" compilerclasspathref="aop.task.classpath" jvm="${java14}">
         <classpath refid="aop.task.classpath"/>
         <classpath refid="test.classpath"/>
         <classpath path="${build.tests.retro}"/>
         <aoppath path="${aoppath}"/>
         <sysproperty key="jboss.aop.instrumentor" value="${instrumentor}"/>
         <sysproperty key="java.io.tmpdir" value="${aopc.tmpdir}"/>
         <src path="${build.tests.retro}"/>
         <include name="org/jboss/test/aop/${test}/**"/>
         <exclude name="${exclude}"/>
         <aopclasspath path="${build.tests.retro}"/>
      </aopc>

      <!-- Get -Djboss.aop.path from passed in parameters -->
      <condition property="jboss.aop.path" value="${aop.xml}">
         <isset property="aop.xml"/>
      </condition>
      <condition property="jboss.aop.path" value="">
         <isset property="no.xml"/>
      </condition>
      <condition property="jboss.aop.path" value="${source.res}/test/${test}/jboss-aop.xml">
         <not>
            <isset property="aop.xml"/>
         </not>
      </condition>

      <!-- Get -Djboss.aop.class.path from passed in parameters -->
      <condition property="jboss.aop.class.path" value="${build.tests.retro}">
         <isset property="use.annotations"/>
      </condition>
      <condition property="jboss.aop.class.path" value="">
         <not>
            <isset property="use.annotations"/>
         </not>
      </condition>

      <!-- determine output directory from weaving mode -->
      <mkdir dir="${build.reports}"/>

      <junit printsummary="yes" fork="yes" haltonfailure="no" jvm="${java14}">
         <sysproperty key="jboss-junit-configuration" value="${caller}-jdk14"/>
         <sysproperty key="jboss.aop.path" value="${jboss.aop.path}"/>
         <sysproperty key="jboss.aop.optimized" value="${optimized}"/>
         <sysproperty key="jboss.aop.class.path" value="${jboss.aop.class.path}"/>
         <formatter type="plain" extension="-${caller}-jdk14.txt"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="true" extension="-${caller}-jdk14.xml"/>
         <sysproperty key="jboss.aop.debug.classes" value="${jboss.aop.debug.classes}"/>
         <classpath>
            <path refid="test.classpath"/>
            <path refid="aopc.classpath"/>
            <pathelement location="${build.tests.retro}"/>
            <pathelement location="docs"/>
         </classpath>
         <batchtest todir="${build.reports}"
            haltonerror="false"
            haltonfailure="false"
            fork="true">
            <fileset dir="${build.tests.retro}">
               <include name="org/jboss/test/aop/${test}/**/*TestCase.class"/>
               <include name="org/jboss/test/aop/${test}/**/*Tester.class"/>
               <exclude name="${exclude}"/>

               <!-- These are not test cases, and so they will fail when junit tries to run them. Should really rename all tests to *TestCase -->
               <exclude name="org/jboss/test/aop/reflection/ReflectionAspectTester.class"/>
               <exclude name="org/jboss/test/aop/basic/POJOAspectTester.class"/>
            </fileset>
         </batchtest>
      </junit>
   </target>


   <!-- ==================================================================================== -->
   <!-- NON-WOVEN TESTS                                                                      -->
   <!-- ==================================================================================== -->

   <target name="not-woven-tests" depends="retroweave">
      <mkdir dir="${build.reports}"/>

      <taskdef name="annotationc" classname="org.jboss.aop.ant.AnnotationC" classpathref="jboss.aop.retro.classpath"/>
      <path id="aop.task.classpath">
         <path refid="library.classpath"/>
         <path refid="dependentmodule.classpath"/>
         <path refid="jboss.aop.retro.classpath"/>
      </path>

      <annotationc compilerclasspathref="aop.task.classpath" bytecode="true">
         <classpath refid="aop.task.classpath"/>
         <classpath path="${build.tests.retro}"/>
         <src path="${source.tests.java}"/>
         <include name="org/jboss/test/aop/annotationc/*.java"/>
      </annotationc>

      <junit printsummary="yes" fork="no" haltonfailure="no" jvm="${java14}">
         <sysproperty key="jboss-junit-configuration" value="jdk14"/>
         <sysproperty key="jboss.aop.debug.classes" value="${jboss.aop.debug.classes}"/>
         <classpath>
            <path refid="test.classpath"/>
            <path refid="aopc.classpath"/>
            <pathelement location="${build.tests.retro}"/>
            <pathelement location="docs"/>
         </classpath>
         <formatter type="plain" extension="-jdk14.xml"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="true" extension="-jdk14.xml"/>

         <batchtest todir="${build.reports}"
            haltonerror="false"
            haltonfailure="false"
            fork="true">
            <fileset dir="${build.tests.retro}">
               <include name="org/jboss/test/aop/proxy/ProxyTestCase.class"/>
               <include name="org/jboss/test/aop/methodhashing/MethodHashingTestCase.class"/>
               <include name="org/jboss/test/aop/annotationc/AnnotationTester.class"/>
               <include name="org/jboss/test/aop/pointcut/PointcutTestCase.class"/>
            </fileset>
         </batchtest>
      </junit>
      <junit printsummary="yes" fork="yes" haltonfailure="no">
         <sysproperty key="jboss.aop.path" value="${source.res}/test/container/jboss-aop.xml"/>
         <sysproperty key="jboss.aop.debug.classes" value="${jboss.aop.debug.classes}"/>
         <classpath>
            <path refid="test.classpath"/>
            <path refid="aopc.classpath"/>
            <pathelement location="${build.tests.retro}"/>
            <pathelement location="docs"/>
         </classpath>
         <sysproperty key="jboss-junit-configuration" value="jdk14"/>
         <formatter type="plain" extension="-jdk14.txt"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter" extension="-jdk14.xml"/>
         <test todir="${build.reports}" name="org.jboss.test.aop.container.ContainerTestCase"/>
      </junit>
   </target>

   <target name="system-classloader-test" depends="compile-test-classes">
      <!-- Even though this is deprecated we should still make sure it works from time to time -->
      <junit printsummary="yes" fork="no" haltonfailure="false" jvm="${java14}">
         <sysproperty key="jboss-junit-configuration" value="-system-classloader-jdk14.xml"/>
         <sysproperty key="java.system.class.loader" value="org.jboss.aop.standalone.SystemClassLoader"/>
         <sysproperty key="jboss.aop.path" value="${source.res}/test/basic/jboss-aop.xml"/>
         <sysproperty key="jboss.aop.instrumentor" value="org.jboss.aop.instrument.ClassicInstrumentor"/>
         <sysproperty key="jboss.aop.debug.classes" value="${jboss.aop.debug.classes}"/>
         <classpath>
            <path refid="test.classpath"/>
            <path refid="jboss.test14.classpath"/>
            <pathelement location="${build.tests.retro}"/>
            <pathelement location="docs"/>
         </classpath>
         <formatter type="plain" extension="-systemclassloader-jdk14.txt"/>
         <formatter classname="org.jboss.ant.taskdefs.XMLJUnitMultipleResultFormatter"
                    usefile="true" extension="-systemclassloader-jdk14.xml"/>
         <test fork="yes" name="org.jboss.test.aop.basic.AOPTester"  todir="${build.reports}"/>
      </junit>
   </target>

   <target name="original-memory-test" depends="compile-test-classes" description="Execute MemoryLeakTestCase">

      <taskdef name="aopc" classname="org.jboss.aop.ant.AopC" classpathref="jboss.aop.retro.classpath"/>
      <property name="test" value="memoryleaks"/>
      <property name="caller" value="memoryleaks"/>
      <property name="aoppath" value="${source.res}/test/${test}/jboss-aop.xml"/>
      <property name="optimized" value="yes"/>
      <echo>Source=${build.tests.retro}</echo>
      <echo message="aoppath=${aoppath}"/>

      <!-- aopc -->
      <aopc compilerclasspathref="aop.task.classpath" jvm="${java14}">
         <classpath refid="aop.task.classpath"/>
         <classpath refid="test.classpath"/>
         <classpath path="${build.tests.retro}"/>
         <sysproperty key="java.io.tmpdir" value="${aopc.tmpdir}"/>
         <aoppath path="${aoppath}"/>
         <src path="${build.tests.retro}"/>
         <include name="org/jboss/test/aop/${test}/**"/>
         <aopclasspath path="${build.tests.retro}"/>
      </aopc>

      <junit printsummary="yes" fork="yes" haltonfailure="no" jvm="${java14}">
         <sysproperty key="jboss.aop.path" value="${aoppath}"/>
         <classpath refid="test15.classpath"/>
         <classpath path="${build.tests.retro}"/>
         <jvmarg value="-agentlib:jbossAgent"/>
         <formatter usefile="true" type="xml"/>
         <formatter usefile="true" type="plain"/>
         <test fork="yes" name="org.jboss.test.aop.memoryleaks.MemoryLeakTester"/>
      </junit>
   </target>
</project>
